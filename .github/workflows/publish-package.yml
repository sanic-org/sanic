name: Upload Python Package

on:
  release:
    types: [created]
  workflow_dispatch:

env:
  IS_TEST: false

jobs:
  build-and-publish-package:
    name: Build and publish package
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: pip install build twine

    - name: Update package version
      run: |
        tag_name="${{ github.event.release.tag_name }}"

        # Remove leading 'v' from the tag name if exists
        if [[ $tag_name == v* ]]; then
          version="${tag_name#v}"
        else
          version="$tag_name"
        fi

        echo "__version__ = \"${version}\"" > sanic/__version__.py

    - name: Build a binary wheel and a source tarball
      run: python -m build --sdist --wheel --outdir dist/ .

    - name: Publish to PyPi ðŸš€
      run: twine upload --non-interactive --disable-progress-bar dist/*
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.SANIC_PYPI_API_TOKEN }}
        TWINE_REPOSITORY: ${{ env.IS_TEST == 'true' && 'testpypi' || 'pypi' }}
