name: Tests

on:
  push:
    branches:
      - main
      - current-release
      - "*LTS"
    tags:
      - "!*"
  pull_request:
    branches:
      - main
      - current-release
      - "*LTS"
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  run_tests:
    name: "${{ matrix.config.platform == 'windows-latest' && 'Windows' || 'Linux' }} / Python ${{ matrix.config.python-version }} / ${{ matrix.config.nox-session }}"
    if: github.event.pull_request.draft == false
    runs-on: ${{ matrix.config.platform || 'ubuntu-latest' }}
    strategy:
      fail-fast: true
      matrix:
        config:
          - { python-version: "3.13", nox-session: security }
          - { python-version: "3.13", nox-session: lint }
          - { python-version: "3.13", nox-session: type_checking }
          # - { python-version: "3.13", nox-session: docs }
          - { python-version: "3.9",  nox-session: tests-3.9,          max-attempts: 3 }
          - { python-version: "3.10", nox-session: tests-3.10,         max-attempts: 3 }
          - { python-version: "3.11", nox-session: tests-3.11,         max-attempts: 3 }
          - { python-version: "3.12", nox-session: tests-3.12,         max-attempts: 3 }
          - { python-version: "3.13", nox-session: tests-3.13,         max-attempts: 3 }
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Run tests
        run: uv run --python ${{ matrix.config.python-version }} nox -s ${{ matrix.config.nox-session }}
        continue-on-error: ${{ matrix.config.ignore-errors || false }}
