# å“åº”å‡½æ•°(Handlers)

ä¸‹ä¸€ä¸ªé‡è¦çš„æ„ä»¶å—æ˜¯ä½ çš„ _handlers_ã€‚ å®ƒä»¬æœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºâ€œè§†å›¾â€ã€‚

åœ¨ Sanic ä¸­ï¼Œå“åº”å‡½æ•°å¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªå¯è°ƒç”¨ç¨‹åºï¼Œå®ƒè‡³å°‘ä»¥ä¸€ä¸ª :class:`sanic.request.Request`  å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª :class:`sanic.response.HTTPResponse` å®ä¾‹æˆ–ä¸€ä¸ªæ‰§è¡Œå…¶ä»–æ“ä½œçš„ååŒç¨‹åºä½œä¸ºå“åº”ã€‚

.. column::

```
å—¯å“¼ï¼ŸğŸ˜•

å“åº”å‡½æ•°ä»…ä»…æ˜¯ä¸€ä¸ª **å‡½æ•°**ï¼Œå¯ä»¥æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥çš„ã€‚

å“åº”å‡½æ•°çš„ä»»åŠ¡æ˜¯å“åº”ä¸€ä¸ªè¯·æ±‚å…¥å£å¹¶åšä¸€äº›æ•°æ®æ“ä½œã€‚ è¿™æ˜¯æ‚¨çš„å¤§å¤šæ•°ä¸šåŠ¡é€»è¾‘å°†è¦èµ°çš„åœ°æ–¹ã€‚
```

.. column::

````
```python
def i_am_a_handler(request):
    return HTTPResponse()

async def i_am_ALSO_a_handler(request):
    return HTTPResponse()
```
````

è¿˜æœ‰å¦å¤–ä¸¤ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š

1. ä½ å¯ä»¥ä¸ç”¨ç›´æ¥ä½¿ç”¨ :class:`sanic.response.HTTPresponse` å®ä¾‹å»è¿”å›æ•°æ® ä½¿ç”¨ä¸€äº›å†…ç½®å°è£…å¥½çš„[ä¾¿æ·æ–¹æ³•](./response#methods)ï¼Œå°†ä¼šå˜çš„æ›´åŠ ç®€å•ã€‚

    - `from sanic import json`
    - `from sanic import html`
    - `from sanic import redirect`
    - _etc_
2. æˆ‘ä»¬ä¼šåœ¨[æµåª’ä½“éƒ¨åˆ†](../advanced/streaming#response-streaming)ä¸­çœ‹åˆ°çš„ï¼Œæ‚¨å¹¶ä¸æ€»æ˜¯éœ€è¦è¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚ å¦‚æœæ‚¨ä½¿ç”¨è¿™ä¸ªåº•å±‚çš„ APIï¼Œæ‚¨å¯ä»¥åœ¨å¤„ç†ç¨‹åºå†…éƒ¨æ§åˆ¶å“åº”çš„æµç¨‹ï¼Œå¹¶ä¸”ä¸éœ€è¦ä½¿ç”¨è¿”å›å¯¹è±¡ã€‚

.. tip:: æç¤º

```
å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºå°è£…é€»è¾‘çš„å†…å®¹ï¼Œå¯ä»¥æŸ¥é˜…[åŸºäºç±»çš„è§†å›¾](../advanced/class-based-views.md)ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä»…åŸºäºå‡½æ•°çš„è§†å›¾è®²è§£ã€‚
```

### ä¸€ä¸ªç®€å•çš„åŸºäºå‡½æ•°çš„å¤„ç†å™¨

åˆ›å»ºè·¯ç”±å¤„ç†ç¨‹åºçš„æœ€å¸¸è§æ–¹å¼æ˜¯è£…é¥°å‡½æ•°ã€‚ å®ƒä¸ºè·¯ç”±å®šä¹‰åˆ›å»ºäº†ä¸€ä¸ªè§†è§‰ä¸Šç®€æ´çš„æ ‡è¯†ã€‚ æˆ‘ä»¬ç¨åå°†äº†è§£æ›´å¤šå…³äº[è·¯ç”±](./routing.md)

.. column::

```
è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚

- æˆ‘ä»¬åœ¨åº”ç”¨å®ä¾‹ä¸Šä½¿ç”¨äº†ä¸€ä¸ªä¾¿æ·è£…é¥°å™¨ï¼š`@app.get()`
- ä»¥åŠä¸€ä¸ªç”¨äºç”Ÿæˆå“åº”å¯¹è±¡çš„ä¾¿æ·æ–¹æ³•ï¼š`text()`

ä»»åŠ¡å®ŒæˆğŸ’ª
```

.. column::

````
```python
from sanic import text

@app.get("/foo")
async def foo_handler(request):
    return text("I said foo!")
```
````

---

## å…³äº _async_...

.. column::

```
å®Œå…¨å¯ä»¥å†™å…¥åŒæ­¥å¤„ç†ç¨‹åºã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ _blocking_ `time.sleep()` æ¨¡æ‹Ÿ100æ¯«ç§’çš„å¤„ç†æ—¶é—´ã€‚ ä¹Ÿè®¸è¿™æ„å‘³ç€ä»æ•°æ®åº“æˆ–ç¬¬ä¸‰æ–¹ç½‘ç«™è·å–æ•°æ®ã€‚

ä½¿ç”¨å››(4)ä¸ªå·¥åºå’Œä¸€ä¸ªå…±åŒçš„åŸºå‡†å·¥å…·ï¼š

- **956** åœ¨ 30.10s
- æˆ–å¤§çº¦**31.76** è¯·æ±‚/ç§’
```

.. column::

````
```python
@app.get("/sync")
def sync_handler(request):
    time.sleep(0.1)
    return text("Done.")
```
````

.. column::

```
åªéœ€å°† `time.sleep()` æ›´æ”¹ä¸ºå¼‚æ­¥æ›¿ä»£æ–¹æ¡ˆ `asyncio.sleep()`ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°æ€§èƒ½æœ‰äº†æ˜¾è‘—æå‡ã€‚ ğŸš€

åŒæ ·ä½¿ç”¨å››ä¸ªï¼ˆ4ï¼‰å·¥ä½œè¿›ç¨‹ï¼š

- åœ¨30.08ç§’å†…å¤„ç†äº† **115,590** ä¸ªè¯·æ±‚
- æˆ–è€…è¯´ï¼Œå¤§çº¦æ¯ç§’å¤„ç† **3,843.17** ä¸ªè¯·æ±‚

.. attrs::
    :class: is-size-2

    ğŸ¤¯
```

.. column::

````
```python
@app.get("/async")
async def async_handler(request):
    await asyncio.sleep(0.1)
    return text("Done.")
```
````

å¥½çš„... è¿™æ˜¯ä¸€ä¸ªå¤¸å¼ å¾—ç¦»è°±çš„ç»“æœã€‚ ä½ ä»¬æ‰€çœ‹åˆ°çš„ä»»ä½•åŸºå‡†éƒ½æœ¬è´¨ä¸Šæ˜¯éå¸¸åé¢‡çš„ã€‚ è¿™ä¸ªä¾‹å­æ—¨åœ¨æåº¦å±•ç¤º`async/await`åœ¨webå¼€å‘é¢†åŸŸçš„ä¼˜åŠ¿ã€‚ ç»“æœè‚¯å®šä¼šæœ‰æ‰€ä¸åŒã€‚ åƒSanicå’Œå…¶ä»–å¼‚æ­¥Pythonåº“å¹¶éç¥å¥‡çš„è§£å†³æ–¹æ¡ˆï¼Œèƒ½è‡ªåŠ¨è®©ç¨‹åºè¿è¡Œæ›´å¿«ã€‚ å®ƒä»¬ä½¿ç¨‹åºæ‰§è¡Œæ›´åŠ é«˜æ•ˆã€‚

åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå¼‚æ­¥ç‰ˆæœ¬ä¹‹æ‰€ä»¥è¡¨ç°ä¼˜ç§€ï¼Œæ˜¯å› ä¸ºå½“ä¸€ä¸ªè¯·æ±‚åœ¨â€œç¡çœ â€ï¼ˆç­‰å¾…ï¼‰æ—¶ï¼Œå®ƒå¯ä»¥å¼€å§‹å¤„ç†å¦ä¸€ä¸ªè¯·æ±‚ï¼Œç„¶åå†å¤„ç†ä¸‹ä¸€ä¸ªã€ä¸‹ä¸€ä¸ªã€ä¸‹ä¸€ä¸ªâ€¦â€¦ä»¥æ­¤ç±»æ¨ï¼Œå®ç°å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œä»è€Œå¤§å¤§æé«˜æœåŠ¡å™¨çš„ååé‡ã€‚

ä½†æ˜¯ï¼Œè¿™å°±æ˜¯å…³é”®æ‰€åœ¨ï¼ Sanicä¹‹æ‰€ä»¥å¿«ï¼Œæ˜¯å› ä¸ºå®ƒå……åˆ†åˆ©ç”¨å¯ç”¨èµ„æºå¹¶æ¦¨å–å…¶æ€§èƒ½æ½œåŠ›ã€‚ å®ƒå¯ä»¥åŒæ—¶å¤„ç†å¤§é‡è¯·æ±‚ï¼Œè¿™å°±æ„å‘³ç€æ¯ç§’èƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚

.. æç¤ºï¼šä¸€ä¸ªå¸¸è§çš„è¯¯åŒºï¼

```
å½“ä½ ä½ éœ€è¦å¯¹ä¸€ä¸ªç½‘ç«™è¿›è¡Œpingæ“ä½œã€‚ä½ ä¼šç”¨ä»€ä¹ˆå·¥å…·ï¼Ÿ`pip install ä½ æœ€çˆ±çš„è¯·æ±‚åº“ `ï¼Œæˆ‘åŠä½ ä¸è¦è¿™æ ·åšğŸ™ˆ

è€Œåº”è¯¥å°è¯•ä½¿ç”¨æ”¯æŒ`async/await`åŠŸèƒ½çš„å®¢æˆ·ç«¯ã€‚ä½ çš„æœåŠ¡å™¨ä¼šå› æ­¤è¯´`è°¢è°¢ä½ `ï¼Œé¿å…ä½¿ç”¨é˜»å¡å‹å·¥å…·ï¼Œå°½é‡é€‰æ‹©èƒ½è‰¯å¥½é€‚åº”å¼‚æ­¥ç”Ÿæ€ç³»ç»Ÿä¸­çš„å·¥å…·ã€‚å¦‚æœä½ éœ€è¦æ¨èï¼Œå¯ä»¥æŸ¥çœ‹[Awesome Sanic](https://github.com/mekicha/awesome-sanic).ã€‚

Sanicåœ¨å…¶æµ‹è¯•åŒ…ï¼ˆsanic-testingï¼‰ä¸­ä½¿ç”¨äº†[httpx](https://www.python-httpx.org/) ğŸ˜œã€‚
```

---

## ä¸€ä¸ªå¸¦å®Œæ•´æ³¨è§£çš„å¤„ç†å™¨

å¯¹äºé‚£äº›ä½¿ç”¨ç±»å‹æ³¨è§£çš„äºº...

```python
from sanic.response import HTTPResponse, text
from sanic.request import Request

@app.get("/typed")
async def typed_handler(request: Request) -> HTTPResponse:
    return text("Done.")
```

## ä¸ºæ‚¨çš„å¤„ç†å™¨å‘½å

æ‰€æœ‰å¤„ç†å™¨éƒ½ä¼šè‡ªåŠ¨å‘½åã€‚ è¿™å¯¹äºè°ƒè¯•å’Œåœ¨æ¨¡æ¿ä¸­ç”ŸæˆURLéå¸¸æœ‰ç”¨ã€‚ å¦‚æœä¸ç‰¹åˆ«æŒ‡å®šï¼Œå°†ä½¿ç”¨çš„åç§°å°±æ˜¯å‡½æ•°çš„å

.. column::

```
ä¾‹å¦‚ï¼Œè¿™ä¸ªå¤„ç†ç¨‹åºå°†è¢«å‘½åä¸ºâ€œfoo_handlerâ€ã€‚
```

.. column::

````
```python
# Handler name will be "foo_handler"
@app.get("/foo")
async def foo_handler(request):
    return text("I said foo!")
```
````

.. column::

```
åŒæ ·ï¼Œæ‚¨å¯ä»¥é€šè¿‡å‘è£…é¥°å™¨ä¼ é€’`name`å‚æ•°æ¥æŒ‡å®šåç§°ã€‚
```

.. column::

````
```python
# Handler name will be "foo"
@app.get("/foo", name="foo")
async def foo_handler(request):
    return text("I said foo!")
```
````

.. column::

```
äº‹å®ä¸Šï¼Œæ­£å¦‚ä½ å°†ä¼šé‡åˆ°çš„æƒ…å†µï¼Œæœ‰æ—¶æ‚¨**å¿…é¡»**æä¾›åç§°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨åŒä¸€å‡½æ•°ä¸Šä½¿ç”¨ä¸¤ä¸ªè£…é¥°å™¨ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦ä¸ºå…¶ä¸­ä¸€ä¸ªæä¾›åç§°ã€‚

å¦‚æœä¸è¿™æ ·åšï¼Œæ‚¨å°†æ”¶åˆ°é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨çš„åº”ç”¨å°†æ— æ³•å¯åŠ¨ã€‚åœ¨æ‚¨çš„åº”ç”¨ä¸­ï¼Œåç§°**å¿…é¡»**æ˜¯å”¯ä¸€çš„ã€‚
```

.. column::

````
```python
# Two handlers, same function,
# different names:
# - "foo_arg"
# - "foo"
@app.get("/foo/<arg>", name="foo_arg")
@app.get("/foo")
async def foo(request, arg=None):
    return text("I said foo!")
```
````
