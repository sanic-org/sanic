---
title: ç‰ˆæœ¬21.3
---

# ç‰ˆæœ¬21.3

.. toc::

## ä¸€. å¯¼è¨€

ç°åœ¨æ²™æ¼ åŒ–é€Ÿåº¦æ›´å¿«ã€‚

å¥½å§ï¼Œå®ƒå·²ç»å¾ˆå¿«äº†ã€‚ ä½†æ˜¯ï¼Œéšç€äºŒåä¸€ä¸–çºªä¼šè®®çš„ç¬¬ä¸€æ¬¡å¤ä¼šï¼Œæˆ‘ä»¬çº³å…¥äº†å‡ ä¸ªé‡å¤§é‡Œç¨‹ç¢‘ï¼Œè¿™äº›é‡Œç¨‹ç¢‘å·²ç»å–å¾—äº†ä¸€äº›å…·ä½“çš„æ”¹è¿›ã€‚ è¿™äº›å»ºè®®åŒ…å«äº†å¤šå¹´æ¥ä¸€ç›´åœ¨å·¥ä½œä¸­çš„ä¸€äº›æƒ³æ³•ï¼Œå¹¶æœ€ç»ˆå°†å…¶å˜æˆäº†å·²ç»å‘è¡¨çš„ç‰ˆæœ¬ã€‚

.. è­¦å‘Šï¼šæ‰“ç ´æ›´æ”¹

````
Version 21.3 introduces a lot of new features. But, it also includes some breaking changes. This is why these changes were introduced after the last LTS. If you rely upon something that has been removed, you should continue to use v20.12LTS until you are able to upgrade.

```bash
pip install "sanic>=20.12,<20.13"
pip freeze > requirements.txt
```

For most typical installations, you should be able to upgrade without a problem.
````

## äº†è§£ä»€ä¹ˆ

æ˜¾è‘—çš„æ–°åŠŸèƒ½æˆ–ç ´æŸåŠŸèƒ½ä»¥åŠå‡çº§å†…å®¹...

### ä»…é™Python 3.7+

æ­¤ç‰ˆæœ¬ä¸¢å¼ƒäº† Python 3.6 æ”¯æŒã€‚ 20.12LTSç‰ˆæœ¬å°†ç»§ç»­æ”¯æŒPython 3.6ï¼Œç›´è‡³2022å¹´12æœˆEOLå’Œ19ç‰ˆã€‚ 2LTSå°†æ”¯æŒå®ƒè‡³2021å¹´12æœˆçš„EOLã€‚

é˜…è¯»æ›´å¤šå…³äºæˆ‘ä»¬çš„ [LTS æ”¿ç­–] (../project/policies.md#long-term support-v-interim-releases).

### ä½œä¸ºä¸€ç­‰å…¬æ°‘ä¸²æµ

æœ€å¤§çš„é€Ÿåº¦æé«˜æ˜¯å°†è¯·æ±‚/å“åº”å‘¨æœŸç»Ÿä¸€ä¸ºå•ä¸€çš„æµç¨‹ã€‚ ä»¥å‰ï¼Œæ­£å¸¸å‘¨æœŸä¸æµå‘¨æœŸä¹‹é—´å­˜åœ¨ç€å·®å¼‚ã€‚ è¿™å·²ç»ç®€åŒ–åˆ°äº†å®ƒçš„ä½ç½®ï¼Œå°½ç®¡API ç°åœ¨ä¿æŒç›¸åŒï¼Œå› ä¸ºå…¼å®¹æ€§ã€‚ å‡€å…»æ¤é‡‘æ˜¯**æ‰€æœ‰**è¯·æ±‚ç°åœ¨éƒ½åº”çœ‹åˆ°æ–°çš„å…»æ¤é‡‘ã€‚

é˜…è¯»æ›´å¤šå…³äº [ä¸²æµå˜åŒ–](../advanced/streading.md#response-streaming)ã€‚

### è·¯ç”±å™¨å…¨é¢æ£€æŸ¥

æ—§çš„Sanicè·¯ç”±å™¨æ˜¯ä»¥æ­£åˆ™è¡¨è¾¾æ–¹å¼ä¸ºåŸºç¡€çš„ã€‚ æ­¤å¤–ï¼Œå®ƒè¿˜é‡åˆ°äº†ä¸€äº›ä½¿å¾—å¾ˆéš¾åœ¨è¿è¡Œæ—¶åŠ ä»¥ä¿®æ”¹çš„é—®é¢˜ï¼Œå¹¶é€ æˆäº†ä¸€äº›ä¸šç»©é—®é¢˜ã€‚ è¿™ç§å˜åŒ–å·²ç»æ˜¯å¤šå¹´äº†ï¼Œç°åœ¨[åœ¨å¯åŠ¨æ—¶å°†è·¯ç”±å™¨è½¬æ¢ä¸ºç¼–è¯‘çš„æ ‘](https://community.sanicframework.org/t/a-å¿«é€Ÿ-new-routter/649/41)ã€‚ å¯»æ±‚å…¨å¹´çš„è¿›ä¸€æ­¥æ”¹è¿›ã€‚

å¤–ç½®çš„ API ä¿æŒäº†åå‘å…¼å®¹æ€§ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä½ ç‰¹åˆ«è®¿é—®è·¯ç”±å™¨å†…çš„ä»»ä½•ä¸œè¥¿ï¼Œä½ å°±ä¼šæ³¨æ„åˆ°ä¸€äº›å˜åŒ–ã€‚ ä¾‹å¦‚ï¼š

1. `Router.get()` æœ‰ä¸€ä¸ªæ–°çš„è¿”å›å€¼
2. `Route` ç°åœ¨æ˜¯ä¸€ä¸ªåˆé€‚çš„ç±»å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª`namedtuple`
3. å¦‚æœæ‰‹åŠ¨æ„å»ºè·¯ç”±å™¨ï¼Œä½ éœ€è¦è°ƒç”¨ `Router.finalize()` æ–¹æ³•æ‰èƒ½ä½¿ç”¨
4. æœ‰ä¸€ä¸ªæ–°çš„ `<date:ymd>` æ¨¡å¼å¯ä»¥åŒ¹é…åˆ°æ‚¨çš„è·¯ç”±
5. æ‚¨ä¸èƒ½åœ¨æ²¡æœ‰å®šä¹‰è‡³å°‘ä¸€ä¸ªè·¯ç”±çš„æƒ…å†µä¸‹å¯åŠ¨åº”ç”¨ç¨‹åº

è·¯ç”±å™¨ç°åœ¨ä½äºè‡ªå·±çš„ä»“åº“ä¸­ï¼š[sanic-org/sanic-router](https://github.com/sanic-org/sanic-router)ï¼Œä¹Ÿæ˜¯è‡ªå·±çš„[PyPIä¸Šçš„ç‹¬ç«‹åŒ…ä»¶](https://pypi.org/project/sanic-routing/)ã€‚

### Signals API â­ï¸

_BETA ç‰¹æ€§ï¼šAPIå°†åœ¨ v21.6_ ä¸­å®Œæˆ

æ–°è·¯ç”±å™¨çš„ä¸€ä¸ªé™„å¸¦å¥½å¤„æ˜¯ï¼Œå®ƒä¹Ÿå¯ä»¥ä¸º[æ–°ä¿¡å·API](https://github.com/sanic-org/sanic/issues/1630)æä¾›åŒé‡åŠ¨åŠ›ã€‚ æ­¤åŠŸèƒ½æ­£åœ¨å‘å¸ƒï¼Œä¾›å…¬å…±ä½¿ç”¨ï¼Œå¾ˆå¯èƒ½å…¬å…±APIå°†ä¸ä¼šæ”¹å˜å…¶æœ€ç»ˆå½¢å¼ã€‚

è¿™ä¸ªç‰¹ç‚¹çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

1. å…è®¸å¼€å‘è€…æ›´å¤šåœ°æ§åˆ¶å’Œè®¿é—®æ’ä»¶åˆ°æœåŠ¡å™¨å’Œè¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼Œ
2. æä¾›æ–°çš„å·¥å…·ï¼Œé€šè¿‡æ‚¨çš„åº”ç”¨ç¨‹åºåŒæ­¥å’Œå‘é€æ¶ˆæ¯ï¼›ä»¥åŠ
3. æœ€ç»ˆè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚

API å¼•å…¥äº†ä¸‰ç§æ–°æ–¹æ³•ï¼š

- `@app.signal(...)` - å®šä¹‰ä¿¡å·å¤„ç†å™¨ã€‚ å®ƒçœ‹èµ·æ¥å¾ˆåƒä¸€æ¡è·¯çº¿ã€‚ æ¯å½“å‘å‡ºæ­¤ä¿¡å·æ—¶ï¼Œæ­¤å¤„ç†ç¨‹åºå°†è¢«æ‰§è¡Œã€‚
- `app.event(...)` - ä¸€ä¸ªå¯åœ¨åº”ç”¨ç¨‹åºä¸­éšæ—¶éšåœ°ç”¨äºæš‚åœæ‰§è¡Œç›´åˆ°äº‹ä»¶è§¦å‘çš„å¯å¾…åŠäº‹å®œã€‚
- `app.signatch(...)` - è§¦å‘ä¸€ä¸ªäº‹ä»¶å¹¶å¯¼è‡´ä¿¡å·å¤„ç†ç¨‹åºè¢«æ‰§è¡Œã€‚

```python
@app.signal("foo.bar.<thing>")
async def signal_handler(notes, **kwargs):
    print(f)[signal_handler] {thing=}", kwargs)

async def wait_for_event(app):
    while True:
        print("> ç­‰å¾…")
        ç­‰å¾…åº”ç”¨ã€‚ vent("foo.bar. ")
        print("> event found\n")

@app. fter_server_start
async def after _server_start(app, rol):
    app. dd_task(wait_for_event(app))

@app.get("/")
async def è§¦å‘å™¨(request):
    ç­‰å¾…app.appailch("foo.bar.baz")
    return response.text("å®Œæˆ")
```

### è·¯ç”±åç§°

è·¯ç”±è¢«`route.name`å’Œ`route.endpoint`å¼•ç”¨. è™½ç„¶ç±»ä¼¼ï¼Œä½†å®ƒä»¬ç•¥æœ‰ä¸åŒã€‚ ç°åœ¨ï¼Œæ‰€æœ‰èˆªçº¿éƒ½å°†**å‰åä¸€è‡´** å‘½åç©ºé—´å¹¶è¢«å¼•ç”¨ã€‚

```text
<app name>ã€‚[å¯é€‰ï¼š<blueprint name>ã€‚]<handler name>
```

è¿™ä¸ªæ–°çš„â€œåç§°â€å·²åˆ†é…ç»™å±æ€§ "route.name"ã€‚ æˆ‘ä»¬æ­£åœ¨åºŸå¼ƒ`route.endpoint`, å¹¶å°†åœ¨ v21.9 ä¸­ç§»é™¤è¯¥å±æ€§ã€‚ åœ¨æ­¤ä¹‹å‰ï¼Œå®ƒå°†æ˜¯`route.name`çš„ä¸€ä¸ªåˆ«åã€‚

æ­¤å¤–ï¼Œä¸ºé™æ€ã€websocketå’Œè“å›¾è·¯çº¿ç­‰äº‹é¡¹ä½¿ç”¨çš„å‘½åå‰ç¼€å·²è¢«åˆ é™¤ã€‚

### æ–°è£…é¥°ç¬¦

å¥½å‡ ä¸ªæ–°çš„æ–¹ä¾¿è£…é¥°å¸ˆå¸®åŠ©IDEè‡ªåŠ¨å®Œæˆã€‚

```python
# åˆ«å @app.listener("...")
@app.befor_server_start
@app.after_server_stop
@app.prev_server_stop
@app.after _server_stop

# åˆ«å @app.midlewarer("...")
@app.on_request
@app.on_response
```

### åœ¨èˆªçº¿ä¸­å–æ¶ˆå¼•ç”¨

å¦‚æœä½ æœ‰ä¸€æ¡ä½¿ç”¨éasciiå­—ç¬¦çš„è·¯ç”±ï¼Œè¨å°¼å…‹å°†ä¸å†èƒ½å¤Ÿä¸ºä½ \`å–æ¶ˆå¼•ç”¨'ã€‚ æ‚¨éœ€è¦å…·ä½“å‘Šè¯‰è·¯çº¿å®šä¹‰å®ƒåº”è¯¥è¿™æ ·åšã€‚

```python
@app.route("/overload/<param>", methods=["GET"], unquote=True)
async def handler2(request, param):
    return text("OK2 " + param)

request, response = app. est_client.get("/overload/potsertifle")
power response.text == "OK2 etail"
```

å¦‚æœä½ å¿˜è®°äº†è¿™ä¸€ç‚¹ï¼Œä½ çš„æ–‡æœ¬å°†ä¿æŒç¼–ç ã€‚

### æ›´æ”¹ `Request.match_info`

`match_info` å§‹ç»ˆæä¾›åŒ¹é…è·¯å¾„å‚æ•°çš„æ•°æ®ã€‚ æ‚¨ç°åœ¨æœ‰æƒä¿®æ”¹è¿™ä¸€ç‚¹ï¼Œä¾‹å¦‚åœ¨ä¸­é—´è¡Œç¨‹ä¸­ã€‚

```python
@app.on_request
def convert_to_snake_case(request):
    request.match_info = to_snake(request.match_info)
```

### è·¯å¾„ä¸­çš„ç‰ˆæœ¬ç±»å‹

ç°åœ¨è·¯ä¸Šçš„ `version` å‚æ•°å¯ä»¥æ˜¯ï¼š

- `str`
- `int`
- `float`

```python
@app.route("/foo", version="2.1.1")
@app.route("/foo", version=2)
@app.route("/foo", version=2.1)
```

### ä¸èº«ä½“ä¸€èµ·å®‰å…¨å¤„ç†æ–¹æ³•

`GET`ã€`HEAD`ã€`OPTIONS`å’Œ`DELETE`çš„è·¯ç”±å¤„ç†ç¨‹åºå°†ä¸ä¼šè§£ç ä¼ é€’ç»™å®ƒçš„ä»»ä½•HTTPä½“ã€‚ æ‚¨å¯ä»¥è¦†ç›–ï¼š

```python
@app.delete(..., ignore_body=False)
```

### åº”ç”¨ç¨‹åºã€ è“å›¾å’Œè“å›¾ç»„å‡ç­‰æ€§

`Sanic` å’Œ `Blueprint` ä¸¤ä¸ªç±»æœ‰ä¸€ä¸ªå…±åŒçš„åŸºç¡€ã€‚ ä»¥å‰ï¼Œå®ƒä»¬é‡å¤äº†è®¸å¤šåŠŸèƒ½ï¼Œå¯¼è‡´å®ƒä»¬ä¹‹é—´çš„æ‰§è¡Œç•¥æœ‰ä¸åŒã€‚ æ—¢ç„¶ä»–ä»¬éƒ½ç»§æ‰¿äº†ç›¸åŒçš„åŸºç¡€ç±»ï¼Œå¼€å‘è€…å’Œæ’ä»¶åº”è¯¥æœ‰ä¸€ä¸ªæ›´åŠ ä¸€è‡´çš„APIã€‚

å¦å¤–ï¼Œè“å›¾ç»„ç°åœ¨ä¹Ÿæ”¯æŒå¸¸è§çš„ URL æ‰©å±•ï¼Œä¾‹å¦‚`version` å’Œ `strict_slashes` å…³é”®å­—å‚æ•°ã€‚

### ä»ä¾èµ–ä¸­ä¸¢å¼ƒ`httpx`

ä¸å†ä¾èµ–`httpx`ã€‚

### å·²åˆ é™¤ `testing` åº“

Sanic å†…éƒ¨æµ‹è¯•å®¢æˆ·ç«¯å·²è¢«ç§»é™¤ã€‚ å®ƒç°åœ¨ä½äºè‡ªå·±çš„ä»“åº“ï¼š[sanic-org/sanic-testing](https://github.com/sanic-org/sanic-testing)å¹¶ä¸”ä¹Ÿæ˜¯è‡ªå·±çš„[PyPIä¸Šç‹¬ç«‹çš„è½¯ä»¶åŒ…](https://pypi.org/project/sanic-testing/)ã€‚

å¦‚æœæ‚¨å·²ç»å®‰è£…äº† `sanic-testing` ï¼Œå®ƒå°†å’Œä»¥å‰ä¸€æ ·åœ¨ä½ çš„ `Sanic()` åº”ç”¨ç¨‹åºä¸Šå¯ç”¨å’Œä½¿ç”¨ã€‚ å› æ­¤ï¼Œæ‚¨éœ€è¦åšçš„**ä»…**æ›´æ”¹æ˜¯å°†`sanic-testing`æ·»åŠ åˆ°æ‚¨çš„æµ‹è¯•å¥—è£…è¦æ±‚ä¸­ã€‚

### åº”ç”¨ç¨‹åºå’Œè¿æ¥çº§åˆ«ç¯å¢ƒ(`ctx`) å¯¹è±¡

ç‰ˆæœ¬19.9 [æ·»åŠ ](https://github.com/sanic-org/sanic/pull/1666/files) the `request.ctx` APIã€‚ è¿™ä¸ªæœ‰ç”¨çš„æ„å»ºå¯ä»¥è½»æ¾åœ°å°†å±æ€§å’Œæ•°æ®é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ (ä¾‹å¦‚) åœ¨ä¸­é—´, å¹¶åœ¨åˆ«å¤„é‡æ–°ä½¿ç”¨ä»–æ‰€ç”³è¯·çš„ä¿¡æ¯ã€‚

åŒæ ·ï¼Œè¿™ä¸€æ¦‚å¿µæ­£åœ¨ä¸¤ä¸ªåœ°æ–¹æ‰©å¤§ï¼š

1. ç”³è¯·å®ä¾‹å’Œ
2. a è¿è¾“è¿æ¥ã€‚

#### åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼š

ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯å°†å±æ€§é™„åŠ åˆ°åº”ç”¨å®ä¾‹ã€‚ ä¸ºäº†ä¸€è‡´æ€§å¹¶é¿å…åç§°ä¸ Sanic å±æ€§ç¢°æ’çš„é—®é¢˜ï¼Œ`ctx` å¯¹è±¡ç°åœ¨å­˜åœ¨äº `Sanic` å®ä¾‹ä¸­ã€‚

```python
@app.before_server_startup
async def startup_db(app, _):
    # WRONG
    app.db = ç­‰å¾…connect_to_db()

    # CORRECT
    app.ctx.db = ç­‰å¾…connect_to_db()
```

#### è¿æ¥ç¯å¢ƒ

å½“å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªä¿æŒç”Ÿå‘½çš„å¤´éƒ¨æ—¶ï¼ŒSanic ä¼šå°è¯•ä¿æŒä¼ é€å¥—æ¥å­—[æ‰“å¼€ä¸€æ®µæ—¶é—´](../deplement/configuration.md#keep-live-timeout)ã€‚ è¿™ä¸ªä¼ è¾“å¯¹è±¡ç°åœ¨æœ‰ä¸€ä¸ª `ctx` å¯¹è±¡å¯ä¾›ä½¿ç”¨ã€‚ è¿™å®é™…ä¸Šæ„å‘³ç€å•ä¸ªå®¢æˆ·ç«¯çš„å¤šæ¬¡è¯·æ±‚ï¼ˆåœ¨è¿è¾“å±‚è¢«é‡æ–°ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼‰å¯èƒ½ä¼šå…±äº«çŠ¶æ€ã€‚

```python
@app.on_request
async def increment_foo(request):
    if not hasattr(request.conn_info.ctx, "foo"):
        request.conn_info.ctx.foo = 0
    request.conn_info.ctx.foo += 1

@app.get("/")
async def count_foo(request):
    return text(f"request.conn_info.ctx.foo={request.conn_info.ctx.foo}")
```

```bash
$ curl localhost:8000 localhost:8000 localhost:8000 localhost:8000
request.conn_info.ctx.foo=1
request.conn_info.ctx.foo=2
request.conn_info.ctx.fo=3
```

.. è­¦å‘Šï¼š:

```
è¿æ¥çº§åˆ«ç¯å¢ƒæ˜¯ä¸€ä¸ªå®éªŒåŠŸèƒ½ï¼Œåº”åœ¨ v21.6 ä¸­æœ€åç¡®å®šã€‚
```

## æ–°é—»

### æ–°çš„é¦–é¡µ ğŸ‰

æˆ‘ä»¬å°†æ–‡ä»¶åˆ†æˆä¸¤éƒ¨åˆ†ã€‚ ä»£ç åº“å†…çš„ç å¤´ä»å°†ç»§ç»­æ„å»ºåˆ° ReadTheDocs çš„ Sphinx æ–‡æ¡£ã€‚ ç„¶è€Œï¼Œå®ƒå°†ä»…é™äºAPIæ–‡æ¡£ã€‚ æ–°çš„é¦–é¡µå°†å­˜æ”¾â€œSanic ç”¨æˆ·æŒ‡å—â€ã€‚

æ–°ç«™ç‚¹è¿è¡ŒäºVuepressã€‚ æ¬¢è¿æä¾›æåŠ©ã€‚ æˆ‘ä»¬è¿˜è¯·å„æ–¹å¸®åŠ©ç¿»è¯‘è¿™äº›æ–‡ä»¶ã€‚

ä½œä¸ºå…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¿˜åˆ·æ–°äº†RTDæ–‡æ¡£å¹¶å°†å…¶æ›´æ”¹ä¸ºä»…APIæ–‡æ¡£ã€‚

### èŠå¤©å·²ç§»åŠ¨åˆ°Discord

Gitter chatroomå·²ç»æœç€é€æ­¥æ·˜æ±°çš„æ–¹å‘è¿ˆå‡ºäº†ä¸€æ­¥ã€‚ åœ¨å®ƒçš„ä½ç½®ï¼Œæˆ‘ä»¬æ‰“å¼€äº†ä¸€ä¸ª[DiscordæœåŠ¡å™¨](https://discord.gg/RARQzAEMAA)ã€‚

### å¼€æ”¾é›†å›¢

è¨å°¼å…‹ç¤¾åŒºç»„ç»‡[æ‰“å¼€äº†ä¸€ä¸ªå¼€æ”¾çš„é›†ä½“é¡µé¢](https://opencollective.com/sanic-org)ï¼Œä»¥ä½¿ä»»ä½•æƒ³è¦èµ„åŠ©è¨å°¼å…‹å‘å±•çš„äººéƒ½èƒ½å¤Ÿè¿™æ ·åšã€‚

### 2021 å‘å¸ƒç®¡ç†å™¨

æ„Ÿè°¢æ‚¨çš„ @sjsadowski å’Œ @yunstanford æ‹…ä»»2019å’Œ2020å¹´çš„é‡Šæ”¾ç®¡ç†å‘˜ã€‚ ä»Šå¹´çš„å‘è¡Œç»ç†æ˜¯ @ahopkins å’Œ @vltrã€‚

## è°¢è°¢ä½ 

Thank you to everyone that participated in this release: :clap:

[@ahopkins](https://github.com/ahopkins) [@akshgpt7](https://github.com/akshgpt7) [@artcg](https://github.com/artcg) [@ashleysommer](https://github.com/ashleysommer)[@elis-k](https://github.com/elis-k) [@harshanarayana](https://github.com/harshanarayana) [@sjsadowski](https://github.com/sjsadowski) [@tronic](https://github.com/tranic) [@vltr](https://github.com/vltr),

[@ConnorZhang](https://github.com/miss85246)å’Œ[@ZinkLu](https://github.com/ZinkLu)å°†æˆ‘ä»¬çš„æ–‡ä»¶ç¿»è¯‘æˆä¸­æ–‡ã€‚

***

ç¡®ä¿æ£€æŸ¥æ›´æ–°æ—¥å¿—ä»¥è·å–æ‰€æœ‰PRç­‰é“¾æ¥ã€‚
